<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Vibezz Room</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .logo {
            font-size: 3em;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .room-code {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            letter-spacing: 2px;
        }
        
        .status {
            margin: 20px 0;
            font-size: 1.1em;
        }
        
        .countdown {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .manual-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .manual-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .instructions {
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.6;
        }
        
        .error {
            color: #ff6b6b;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ðŸŽµ</div>
        <div class="title">Join Vibezz Room</div>
        <div class="room-code" id="roomCode">Loading...</div>
        <div class="status" id="status">Attempting to open Vibezz app...</div>
        <div class="countdown" id="countdown"></div>
        
        <a href="#" class="manual-link" id="manualLink">Open Vibezz App</a>
        
        <div class="instructions">
            <strong>If the app doesn't open automatically:</strong><br>
            1. Tap the button above<br>
            2. Or open Vibezz app manually<br>
            3. Go to "Join Room"<br>
            4. Enter the room code shown above
        </div>
        
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                room: urlParams.get('room') || urlParams.get('roomCode') || 'INVALID',
                source: urlParams.get('source') || 'direct'
            };
        }

        function updateUI(roomCode) {
            document.getElementById('roomCode').textContent = roomCode;
            
            if (roomCode === 'INVALID') {
                document.getElementById('status').textContent = 'Invalid room code';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'No valid room code found in URL';
                return;
            }
        }

        function attemptDeepLink(roomCode, attempt = 1) {
            const maxAttempts = 3;
            const deepLink = `exp+vibezz://join/${roomCode}`;
            
            console.log(`Attempt ${attempt}: Opening deep link:`, deepLink);
            
            // Update manual link
            document.getElementById('manualLink').href = deepLink;
            
            // Try to open the deep link
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = deepLink;
            document.body.appendChild(iframe);
            
            // Also try window.location for better compatibility
            setTimeout(() => {
                try {
                    window.location.href = deepLink;
                } catch (e) {
                    console.log('Direct navigation failed:', e);
                }
                document.body.removeChild(iframe);
            }, 100);
            
            // Retry logic
            if (attempt < maxAttempts) {
                setTimeout(() => {
                    document.getElementById('status').textContent = `Retry ${attempt + 1}/${maxAttempts}...`;
                    attemptDeepLink(roomCode, attempt + 1);
                }, 2000);
            } else {
                document.getElementById('status').textContent = 'Please use the manual button if app didn\'t open';
            }
        }

        function startCountdown() {
            let count = 10;
            const countdownEl = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                if (count > 0) {
                    countdownEl.textContent = `Auto-retry in ${count}s`;
                    count--;
                } else {
                    countdownEl.textContent = '';
                    clearInterval(timer);
                }
            }, 1000);
        }

        // Main execution
        window.addEventListener('load', () => {
            const params = getUrlParams();
            console.log('URL params:', params);
            
            updateUI(params.room);
            
            if (params.room !== 'INVALID') {
                // Immediate attempt
                attemptDeepLink(params.room);
                
                // Start countdown for user reference
                startCountdown();
                
                // Handle page visibility changes (user returning to browser)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        document.getElementById('status').textContent = 'Welcome back! Try the manual button if needed.';
                    }
                });
            }
        });

        // Handle back button or app switch detection
        let hidden = false;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                hidden = true;
                console.log('Page hidden - likely app opened');
            } else if (hidden) {
                console.log('Page visible again - user returned');
                document.getElementById('status').textContent = 'Returned to browser. Try manual button if app didn\'t work.';
            }
        });

        // Prevent page unload issues
        window.addEventListener('beforeunload', (e) => {
            console.log('Page unloading - likely app opened successfully');
        });
    </script>
</body>
</html>
