<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Vibezz Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .room-code {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 4px;
            color: #007AFF;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }

        .button:hover {
            background: #0056b3;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .extension-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #1976d2;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üéµ</div>
        <h1 class="title">Join Vibezz Room</h1>
        <p class="subtitle">Connecting you to the music room...</p>
        
        <div id="roomCode" class="room-code">Loading...</div>
        
        <div id="status" class="status loading">
            <div class="spinner"></div>
            <div>Checking room availability...</div>
        </div>

        <div id="extensionInfo" class="extension-info" style="display: none;">
            <strong>Vibezz Extension Required</strong><br>
            Please install the Vibezz Chrome extension to join rooms.
        </div>

        <div id="buttons" style="display: none;">
            <button id="joinButton" class="button">Join Room</button>
            <button id="copyButton" class="button">Copy Room Code</button>
        </div>
    </div>

    <script>
        // Firebase configuration (same as your extension)
        const firebaseConfig = {
            apiKey: "AIzaSyCwRi8TavzwKTTf8OFa6hZ553arHtCrW2c",
            authDomain: "vibezz-376f7.firebaseapp.com",
            databaseURL: "https://vibezz-376f7-default-rtdb.firebaseio.com",
            projectId: "vibezz-376f7",
            storageBucket: "vibezz-376f7.firebasestorage.app",
            messagingSenderId: "662780995618",
            appId: "1:662780995618:web:01ba3bccca34395e95827b",
            measurementId: "G-WTFQVZCZDD"
        };

        let roomCode = null;
        let roomExists = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            extractRoomCode();
            checkRoomExists();
            checkExtensionInstalled();
        });

        // Extract room code from URL
        function extractRoomCode() {
            const urlParams = new URLSearchParams(window.location.search);
            roomCode = urlParams.get('room');
            
            if (roomCode) {
                document.getElementById('roomCode').textContent = roomCode;
                console.log('üì± Extracted room code:', roomCode);
            } else {
                showError('No room code found in URL');
            }
        }

        // Check if room exists in Firebase
        async function checkRoomExists() {
            if (!roomCode) return;

            try {
                updateStatus('loading', 'Checking room availability...');
                
                const response = await fetch(`${firebaseConfig.databaseURL}/rooms/${roomCode}.json`);
                const roomData = await response.json();
                
                if (roomData) {
                    roomExists = true;
                    updateStatus('success', 'Room found! Ready to join.');
                    showButtons();
                } else {
                    updateStatus('error', 'Room not found or has expired.');
                }
            } catch (error) {
                console.error('‚ùå Failed to check room:', error);
                updateStatus('error', 'Failed to check room availability.');
            }
        }

        // Check if Vibezz extension is installed
        function checkExtensionInstalled() {
            // Try to detect the extension
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage('glflkmiogokmacpbehpgbcigbeckhdmk', { type: 'PING' }, function(response) {
                    if (chrome.runtime.lastError) {
                        // Extension not installed
                        showExtensionInfo();
                    } else {
                        // Extension is installed, try to join automatically
                        if (roomExists) {
                            autoJoinRoom();
                        }
                    }
                });
            } else {
                // Not in Chrome or extension context
                showExtensionInfo();
            }
        }

        // Auto-join room if extension is available
        function autoJoinRoom() {
            if (!roomCode || !roomExists) return;

            try {
                updateStatus('loading', 'Joining room automatically...');
                
                // Send message to extension to join room
                chrome.runtime.sendMessage('glflkmiogokmacpbehpgbcigbeckhdmk', {
                    type: 'JOIN_ROOM_FROM_WEB',
                    roomCode: roomCode
                }, function(response) {
                    if (chrome.runtime.lastError) {
                        console.log('Extension not available for auto-join');
                        showButtons();
                    } else if (response && response.success) {
                        updateStatus('success', 'Successfully joined the room!');
                        // Redirect to YouTube after a delay
                        setTimeout(() => {
                            window.location.href = 'https://www.youtube.com';
                        }, 2000);
                    } else {
                        updateStatus('error', 'Failed to join room automatically.');
                        showButtons();
                    }
                });
            } catch (error) {
                console.error('‚ùå Auto-join failed:', error);
                showButtons();
            }
        }

        // Manual join button
        document.getElementById('joinButton').addEventListener('click', function() {
            if (!roomCode) return;
            
            // Try to open YouTube with the room code
            const youtubeUrl = `https://www.youtube.com/?vibezzRoom=${roomCode}`;
            window.open(youtubeUrl, '_blank');
            
            updateStatus('success', 'Opening YouTube... Please install the Vibezz extension to join the room.');
        });

        // Copy room code button
        document.getElementById('copyButton').addEventListener('click', function() {
            if (!roomCode) return;
            
            navigator.clipboard.writeText(roomCode).then(function() {
                updateStatus('success', 'Room code copied to clipboard!');
            }).catch(function() {
                updateStatus('error', 'Failed to copy room code.');
            });
        });

        // Update status display
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            
            if (type === 'loading') {
                statusEl.innerHTML = `
                    <div class="spinner"></div>
                    <div>${message}</div>
                `;
            } else {
                statusEl.innerHTML = `<div>${message}</div>`;
            }
        }

        // Show extension info
        function showExtensionInfo() {
            document.getElementById('extensionInfo').style.display = 'block';
        }

        // Show action buttons
        function showButtons() {
            document.getElementById('buttons').style.display = 'block';
        }

        // Show error
        function showError(message) {
            updateStatus('error', message);
        }

        // Handle deep link from mobile apps
        function handleDeepLink() {
            const url = window.location.href;
            console.log('üîó Deep link received:', url);
            
            // Check for different URL formats
            if (url.includes('exp+vibezz://join/')) {
                const extractedCode = url.split('exp+vibezz://join/')[1];
                if (extractedCode) {
                    roomCode = extractedCode;
                    document.getElementById('roomCode').textContent = roomCode;
                    checkRoomExists();
                }
            }
        }

        // Initialize deep link handling
        handleDeepLink();
    </script>
</body>
</html>
